---
title: "GK Zone"
author: "Joseph Kroymann"
date: "1/6/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE}
library(worldfootballR)
library(tidyverse)
library(ggplot2)
library(ggiraph)
library(MetBrewer)
```

```{r, echo=FALSE}
gk_data <- fb_big5_advanced_season_stats(season_end_year = 2022,
                                            stat_type = "keepers",
                                            team_or_player = "player")

gk_data_adv <- fb_big5_advanced_season_stats(season_end_year = 2022,
                                            stat_type = "keepers_adv",
                                            team_or_player = "player")

pl_keepers <- gk_data %>%
  filter(Comp == "Premier League", Min_Playing > 900)

pl_keepers_adv <- merge(gk_data_adv, pl_keepers)
colnames(pl_keepers_adv)[colnames(pl_keepers_adv) == "#OPA_Sweeper"] <- "OPA_Sweeper"
colnames(pl_keepers_adv)[colnames(pl_keepers_adv) == "#OPA_per_90_Sweeper"] <- "OPA_Sweeper_per_90"
colnames(pl_keepers_adv)[colnames(pl_keepers_adv) == "_per_90_Expected"] <- "per_90"
colnames(pl_keepers_adv)[colnames(pl_keepers_adv) == "PSxG+_per__minus__Expected"] <- "PSxG_minus_GA"
```

```{r, echo=FALSE}
# how to accumulate expected goals scored against each goalie?? ( not possible w/fbref :( )
```

```{r, echo=FALSE}
prettyZero <- function(l){
    max.decimals = max(nchar(str_extract(l, "\\.[0-9]+")), na.rm = T)-1
    lnew = formatC(l, replace.zero = T, zero.print = "0",
        digits = max.decimals, format = "f", preserve.width=T)
    return(lnew)
}

# who's beating the model?
gk_model <- function(data) {
  ggplot(data = data, aes(x = SoTA, y = PSxG_minus_GA, colour = Save_percent)) +
           xlim(40, 100) +
           geom_vline(xintercept = 70, colour = "white", linetype = "dashed") +
           geom_hline(yintercept = 0, colour = "white", linetype = "dashed") +
           geom_point_interactive(aes(size = 3, tooltip = paste(Player, " - ", Squad, "\n",
                                                                "PSxG - GA: ", PSxG_minus_GA, "\n",
                                                                "SoTA: ", SoTA, "\n",
                                                                "GA: ", GA,
                                                                sep = ),
                                      data_id = Playerf)) + 
           scale_colour_gradientn(colours = met.brewer("OKeeffe2", n = 5)) +
           scale_y_continuous(limits = c(-8, 8),
                              breaks = c(-8, -6, -4, -2, 0, 2, 4, 6, 8)) +
           labs(title = "Who's Beating the Model? (And Does it Matter?)",
                subtitle = "Shot Stopping Ability by Shots on Target for PL GK's (> 900 minutes played)") +
           xlab("Shots on Target Against") +
           ylab("Post-Shot Expected Goals - Goals Allowed per 90") +
           guides(size = FALSE,
                  colour = guide_colourbar(label.position = "bottom",
                                           title.position = "top",
                                           title = "Save %",
                                           )
                  ) +
           theme(
             text = element_text(colour = "white"),
             title = element_text(size = 12),
            
             plot.background = element_rect(fill = "black"),
            
             axis.title = element_text(colour = "white", size = 10),
             axis.title.y = element_text(margin = margin(0, 7.5, 0, 5)),
             axis.title.x = element_text(margin = margin(2.5, 0, 5, 0)),
             axis.text = element_text(colour = "white"),
             axis.ticks = element_line(colour = "white", linetype = "longdash"),
             axis.line = element_line(colour = "white"),
             
             panel.background = element_rect(colour = "black", fill = "black"),
             panel.grid = element_blank(),
            
             legend.position = c(0.175, 0.8),
             legend.direction = "horizontal",
             legend.background = element_rect(colour = "white", fill = "black", linetype = "dashed"),
             legend.text = element_text(colour = "white"),
             legend.title = element_text(colour = "white"),
             legend.title.align = 0.5,
             legend.key.size = unit(0.75, "cm")
)}

girafe(ggobj = gk_model,
       width_svg = 8, height_svg = 5)
```

```{r, echo=FALSE}
gk_sweeper <- function(data) {
  ggplot(data = pl_keepers_adv, aes(x = OPA_Sweeper_per_90, y = AvgDist_Sweeper)) +
    geom_text(aes(x = 0.25, y = 18, label = "Outside of Box", vjust = 1.5), colour = "white") +
    geom_text(aes(x = 1.41, y = 12, label = "Penalty Spot", vjust = -1), colour = "white") +
    geom_hline(yintercept = 12, colour = "white", linetype = "dashed") +
    geom_hline(yintercept = 18, colour = "white", linetype = "dashed") +
    
    geom_point_interactive(size = 3, colour = met.brewer("Lakota", n = 1), 
                         aes(tooltip = paste(Player, " - ", Squad, "\n",
                                             "Avg Distance: ", AvgDist_Sweeper, "\n",
                                             "Def Actions per 90: ", OPA_Sweeper_per_90, "\n",
                                             sep = ""),
                             data_id = Player)) +
    labs(title = "Sweeper or Nah?",
        subtitle = "Distance of Defensive Actions from Goal by Activity Outside of the Penalty Area") +
  
  xlab("Defensive Actions Outside of Penalty Area per 90") +
  ylab("Average Distance from Goal of All Defensive Actions (Yards)") +
  
  theme(
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "black"),
    text = element_text(colour = "white"),
    
    plot.background = element_rect(fill = "black"),
    
    axis.line = element_line(colour = "white"),
    axis.text = element_text(colour = "white"),
    axis.title = element_text(colour = "white", size = 10),
    axis.ticks = element_line(colour = "white"),
    axis.title.y = element_text(margin = margin(0, 7.5, 0, 5)),
    axis.title.x = element_text(margin = margin(4, 0, 5, 0)),
    
    title = element_text(size = 14, margin = margin(5, 0, 0, 0))
    )
}

girafe(
  ggobj = gk_sweeper(pl_keepers_adv)
)


```

